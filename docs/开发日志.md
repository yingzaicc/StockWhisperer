# 开发日志

记录 StockWhisperer 的开发历程、版本更新和重要变更。

---

## v1.0.2 (2026-01-30)

### 📊 数据提取重构

#### 问题
- 价格提取错误,经常获取到大盘指数价格(4157.98)而非个股价格(122.40)
- 多策略回退机制导致逻辑复杂,难以维护
- 数据准确性要求高,宁可报错也不能返回错误数据

#### 解决方案

**1. 精确定位策略**
```
科创板 (688981):
  容器: .zs_brief 或 .zsquote3l
  ├─ 当前价格: .price_down / .price_up
  ├─ 涨跌幅: .zd
  └─ 成交量: .price_draw.blinkgreen
```

**2. 严格验证机制**
- 找不到元素 → 抛出错误
- 价格格式不正确 → 抛出错误
- 价格 <= 0 → 抛出错误
- 价格 >= 1000 且是整数 → 抛出错误(疑似大盘指数)

**3. 简化代码结构**
- 移除5个策略的多层回退逻辑
- 使用单一可靠的容器定位策略
- 每个市场类型使用专门的提取逻辑

#### 已知问题
- ⚠️ 成交量提取仍有问题(暂停修复)

---

## v1.0.2 (2026-01-29)

### ✨ 功能优化

#### 1. 数据确认界面

**新增工作流程**:
```
页面加载 → 提取数据 → 【显示确认界面】 → 用户确认 → AI预测
```

**新增功能**:
- 数据确认界面,显示提取的完整股票数据
- 用户验证后才调用AI API
- 避免错误数据浪费API调用

**技术实现**:
- 新增 `showDataConfirmation()` 函数
- 新增 `stockwhisperer-data-confirmed` 事件
- 数据提取与AI预测解耦

#### 2. 可调整大小侧边栏

**功能**:
- 拖动左侧边缘调整面板宽度(300px-800px)
- 使用 `GM_setValue` 持久化保存用户设置
- 下次访问自动恢复上次宽度

**实现细节**:
- 添加 `.resize-handle` 调整手柄
- 监听 `mousedown`/`mousemove`/`mouseup` 事件
- 实时更新 `panel.style.width`

#### 3. 最小化功能

**功能**:
- 点击最小化按钮 `-` 收缩面板
- 只显示标题栏,节省屏幕空间
- 点击 `+` 恢复完整面板

---

## v1.0.1 (2026-01-29)

### 🐛 Bug修复

#### Bug #1: 科创板术语错误

**问题**: `kcb` 被误标注为"可转债"

**修复**:
- 修改为"科创板"(STAR Market)
- 更新所有相关注释和文档
- 类型标识从 `'bond'` 改为 `'kcb_stock'`

#### Bug #2: 价格提取错误

**问题**: 提取到大盘指数价格而非个股价格

**原因**: 价格验证逻辑不正确:
```javascript
// 错误的逻辑
if (price < 1000 || price % 1 !== 0) {
    return price;  // 4157.98 % 1 !== 0,会被接受
}
```

**修复**: 使用3类价格分类系统:
```javascript
if (price < 1000) {
    // 肯定是个股
} else if (price % 1 !== 0) {
    // 高价股（有小数）
} else {
    // 大盘指数（整数）→ 跳过
}
```

#### Bug #3: 策略3提取错误

**问题**: 查找包含股票代码的父容器策略容易提取错误价格

**修复**: 禁用策略3,使用更可靠的容器定位策略

---

## 技术决策记录

### 为什么移除多策略回退?

**之前**: 5个策略依次尝试,找到就返回
- 问题: 无法保证数据准确性
- 问题: 第一个策略可能返回错误数据
- 问题: 调试困难

**现在**: 单一可靠策略 + 严格验证
- 优势: 数据准确性高
- 优势: 找不到就报错,不会返回错误数据
- 优势: 代码简单易维护

### 为什么添加数据确认界面?

**原因**:
1. 数据准确性要求高
2. 避免浪费API调用
3. 用户可以验证提取的数据

**效果**:
- 用户满意度提升
- API成本降低
- 调试更容易

---

## 开发规范

### 代码规范

1. **数据提取**: 宁可报错,不错返回
2. **错误处理**: 抛出明确的错误信息
3. **日志记录**: 每个步骤都有清晰日志
4. **验证机制**: 严格的数据验证

### Git提交规范

```
feat: 新功能
fix: Bug修复
refactor: 重构
docs: 文档更新
perf: 性能优化
```

---

## 下一步计划

### 短期 (v1.0.3)
- [ ] 修复成交量提取问题
- [ ] 支持更多市场类型
- [ ] 优化错误提示信息

### 中期 (v1.1)
- [ ] 增加历史准确率统计
- [ ] 支持自定义主题
- [ ] 批量分析功能

### 长期 (v2.0)
- [ ] 升级为Chrome插件
- [ ] 开发独立Web应用
- [ ] 支持多市场

---

**维护者**: StockWhisperer Team
**最后更新**: 2026-01-30
