# StockWhisperer 调试指南

**版本**: v1.0.1
**更新日期**: 2026-01-29

---

## 🔧 问题诊断流程

### 步骤1: 检查脚本是否加载

打开浏览器控制台（按 `F12`），切换到 `Console` 标签，刷新页面。

**预期看到**:
```
[StockWhisperer] 开始启动脚本...
[StockWhisperer] 当前页面URL: https://quote.eastmoney.com/SZ000001.html
[StockWhisperer] 页面状态: complete
[StockWhisperer] StockWhisperer v1.0.1 - 倾听股市，洞见未来
```

**如果看不到以上日志**:
- ❌ 脚本未加载
- 检查 Tampermonkey 是否启用
- 检查脚本是否已安装并启用
- 检查 `@match` 规则是否匹配当前 URL

---

### 步骤2: 检查页面类型检测

继续查看控制台日志：

**预期看到**:
```
[StockWhisperer] ==================== 脚本初始化开始 ====================
[StockWhisperer] 脚本已加载
[StockWhisperer] Tampermonkey API 可用: true
[StockWhisperer] 当前URL: https://quote.eastmoney.com/SZ000001.html
[StockWhisperer] 检测到股票详情页
[StockWhisperer] 确认为股票详情页，继续执行
```

**如果看到 "非股票详情页，跳过"**:
- ❌ 页面类型检测失败
- 原因：URL 格式不匹配
- 解决方案：见下面的 "常见问题" 部分

---

### 步骤3: 检查 API 配置

继续查看控制台：

**预期看到**:
```
[StockWhisperer] API提供商: deepseek
[StockWhisperer] API配置存在: true
[StockWhisperer] API Key存在: true
```

**如果看到 "API Key存在: false"**:
- ⚠️ 未配置 API Key
- 页面右上角会弹出 AI 预测面板
- 面板中会显示错误："请先配置API Key才能使用AI预测功能"
- 点击面板的 "⚙️ 设置" 按钮配置 API Key

---

### 步骤4: 检查数据提取

**预期看到**:
```
[StockWhisperer] 提取股票数据...
[DataExtractor] 提取的数据: {
    code: "000001",
    name: "平安银行",
    market: "SZ",
    currentPrice: 15.23,
    changePercent: 1.19,
    volume: 1234567,
    timestamp: 1706500000000
}
[StockWhisperer] 股票数据: {...}
```

**如果 currentPrice 为 0**:
- ❌ 数据提取失败
- 检查 DOM 选择器是否匹配页面结构
- 见下面的 "数据提取调试" 部分

---

### 步骤5: 检查 AI 预测

**预期看到**:
```
[StockWhisperer] 开始AI预测...
[StockWhisperer] 预测结果: {
    predictPrice: 15.68,
    changePercent: 3.0,
    trend: "UP",
    suggestion: "BUY",
    confidence: 75,
    ...
}
[StockWhisperer] 预测结果: {...}
```

**如果看到 API 调用错误**:
- ❌ API 调用失败
- 检查 API Key 是否有效
- 检查网络连接
- 检查 API 余额是否充足

---

## 🐛 常见问题诊断

### 问题1: 脚本完全不运行

**症状**: 控制台没有任何 `[StockWhisperer]` 日志

**诊断步骤**:

1. **检查 Tampermonkey**
   - 打开 Tampermonkey 管理面板
   - 确认脚本在列表中
   - 确认脚本旁边的开关是打开的（彩色）

2. **检查 URL 匹配**
   - 脚本头部有 `@match` 规则：
     ```javascript
     // @match        https://quote.eastmoney.com/*
     // @match        https://emweb.eastmoney.com/*
     ```
   - 当前 URL 必须匹配这些规则
   - 测试 URL：`https://quote.eastmoney.com/SZ000001.html`

3. **重新安装脚本**
   - 删除旧脚本
   - 重新粘贴代码
   - 保存

---

### 问题2: 页面类型检测失败

**症状**: 控制台显示 "非股票详情页，跳过" 或 "未知页面类型"

**原因**: URL 格式不匹配

**诊断步骤**:

1. **查看当前 URL**
   ```
   [StockWhisperer] 当前URL: https://quote.eastmoney.com/SZ000001.html
   ```

2. **验证 URL 格式**
   - 正确格式：`quote.eastmoney.com/SZ000001.html`
   - 正确格式：`quote.eastmoney.com/SH600000.html`
   - 错误格式：`quote.eastmoney.com/sz000001` (小写)
   - 错误格式：`quote.eastmoney.com/` (首页)

3. **测试其他股票**
   - 尝试访问：
     - https://quote.eastmoney.com/SZ000001.html (平安银行)
     - https://quote.eastmoney.com/SH600000.html (浦发银行)
     - https://quote.eastmoney.com/SZ000002.html (万科A)

---

### 问题3: 数据提取失败

**症状**: `currentPrice` 为 0，或看到错误 "无法获取股票数据"

**诊断步骤**:

1. **查看提取的数据**
   ```
   [DataExtractor] 提取的数据: {
       code: "000001",
       name: "平安银行",
       currentPrice: 0,  // ← 这里是0
       ...
   }
   ```

2. **检查页面 DOM**
   - 打开控制台
   - 切换到 `Elements` 标签
   - 搜索价格相关的元素：
     - 使用 `Ctrl+F` 搜索 "price"
     - 查看实际的类名和 ID

3. **手动提取测试**
   - 在控制台运行：
     ```javascript
     // 测试价格选择器
     document.querySelectorAll('[class*="price"]')
     document.querySelector('.current-price')

     // 测试名称选择器
     document.querySelector('h1').textContent
     document.title
     ```

4. **报告问题**
   - 截图 DOM 结构
   - 记录实际页面的 URL
   - 提交 Issue

---

### 问题4: API 调用失败

**症状**: 看到 "API调用失败" 或 "请求超时"

**诊断步骤**:

1. **检查 API Key**
   - 打开设置对话框
   - 确认 API Key 已填写
   - 尝试重新输入

2. **测试 API**
   - 使用 curl 测试（替换 YOUR_API_KEY）：
     ```bash
     curl https://api.deepseek.com/v1/chat/completions \
       -H "Authorization: Bearer YOUR_API_KEY" \
       -H "Content-Type: application/json" \
       -d '{
         "model": "deepseek-chat",
         "messages": [{"role": "user", "content": "Hello"}]
       }'
     ```

3. **检查网络**
   - 打开控制台 `Network` 标签
   - 刷新页面
   - 查找对 `api.deepseek.com` 的请求
   - 查看请求状态码和响应

4. **检查余额**
   - 登录 DeepSeek 控制台
   - 查看账户余额
   - 查看使用记录

---

### 问题5: 面板不显示

**症状**: 脚本运行正常，但没有看到预测面板

**诊断步骤**:

1. **检查面板元素**
   - 在控制台运行：
     ```javascript
     document.getElementById('stockwhisperer-panel')
     ```

2. **检查 z-index**
   - 面板可能被其他元素覆盖
   - 在控制台运行：
     ```javascript
     const panel = document.getElementById('stockwhisperer-panel');
     if (panel) {
         panel.style.zIndex = '99999';
         panel.style.display = 'block';
     }
     ```

3. **检查面板位置**
   - 面板应该在页面右侧
   - 如果屏幕太小，可能被挤出视口
   - 滚动页面或调整窗口大小

---

## 🔍 高级调试技巧

### 1. 手动触发初始化

在控制台运行：
```javascript
App.init();
```

### 2. 手动触发数据提取

```javascript
DataExtractor.smartExtractStockData().then(data => {
    console.log('提取的数据:', data);
});
```

### 3. 手动触发 UI 渲染

```javascript
UIModule.createPredictionPanel();
UIModule.showPredictionResult(
    { code: '000001', name: '平安银行', currentPrice: 15.23 },
    {
        predictPrice: 15.68,
        changePercent: 3.0,
        trend: 'UP',
        suggestion: 'BUY',
        confidence: 75,
        reason: {
            technical: '测试技术面',
            fundamental: '测试基本面',
            sentiment: '测试情绪面'
        }
    }
);
```

### 4. 查看存储的数据

```javascript
// 查看 API 配置
GM_getValue('api_configs');
GM_getValue('current_provider');

// 清除所有数据（重置脚本）
GM_deleteValue('api_configs');
GM_deleteValue('current_provider');
// 然后刷新页面
```

### 5. 启用详细日志

在脚本开头添加：
```javascript
localStorage.setItem('stockwhisperer_debug', 'true');
```

---

## 📋 调试检查清单

使用此清单逐项检查：

- [ ] Tampermonkey 已安装
- [ ] 脚本已添加到 Tampermonkey
- [ ] 脚本已启用（开关是彩色的）
- [ ] 访问的是正确的 URL 格式
- [ ] 控制台显示 `[StockWhisperer]` 日志
- [ ] 检测到股票详情页
- [ ] API Key 已配置
- [ ] 数据提取成功（currentPrice > 0）
- [ ] API 调用成功
- [ ] 预测面板显示在页面上

---

## 🆘 获取帮助

如果以上步骤都无法解决问题：

1. **收集调试信息**
   - 截图控制台日志
   - 记录访问的 URL
   - 记录浏览器版本

2. **创建 Issue**
   - GitHub: [提交问题](https://github.com/your-repo/issues)
   - 描述问题
   - 附上截图和日志

3. **联系开发者**
   - Email: your-email@example.com
   - 提供详细的复现步骤

---

**调试愉快！** 🔧
# 🔧 脚本未执行问题 - 紧急修复指南

## 问题诊断

根据你的反馈：
- ✅ URL 匹配成功
- ❌ 控制台没有 `[StockWhisperer]` 日志
- 🖥️ 使用的是 **Tauri 应用程序**（从 `file://blob:http://tauri.localhost/` 判断）

**核心问题**: 脚本完全没有执行！

---

## 🎯 立即测试方案

### 方案1: 使用测试版脚本（最简单）

我创建了一个超简单的测试脚本，**会显示明显的红色横幅**。

**操作步骤**:

1. 打开 Tampermonkey 管理面板
2. 点击 "+" 创建新脚本
3. 删除所有内容
4. 复制以下文件内容：
   - 文件名：`stockwhisperer-test.user.js`
   - 位置：E:\project\golang\private\StockWhisperer\stockwhisperer-test.user.js
5. 保存
6. 刷新股票页面

**预期结果**:
- ✅ 页面顶部出现红色横幅："✅ StockWhisperer 脚本正在运行！"
- ✅ 页面标题临时改为："🤖 ✅ StockWhisperer 脚本已加载！"
- ✅ 弹出 alert 对话框
- ✅ 控制台显示日志

---

### 方案2: 检查当前安装

**在控制台运行以下代码**:

```javascript
// 检查是否有其他脚本冲突
console.log('页面上的脚本:', document.scripts.length);
console.log('Tampermonkey:', typeof GM_xmlhttpRequest);
console.log('当前URL:', window.location.href);

// 检查是否在iframe中
console.log('在iframe中:', window !== window.top);
console.log('iframe URL:', window.location.href);

// 检查是否有CSP限制
const metaCSP = document.querySelector('meta[http-equiv="Content-Security-Policy"]');
console.log('CSP策略:', metaCSP ? metaCSP.getAttribute('content') : '无');
```

---

### 方案3: 环境问题排查

根据你的 Tauri 环境，可能的问题：

#### 问题 A: Tauri 不支持 Tampermonkey

**解决方案**: 使用普通浏览器测试

1. **Chrome/Edge**
   - 直接访问：https://quote.eastmoney.com/SZ000001.html
   - 不是通过 Tauri 应用

2. **Firefox**
   - 访问相同 URL

3. **验证脚本在普通浏览器中工作**

#### 问题 B: 脚本安装不完整

**解决步骤**:

1. 打开 Tampermonkey 管理面板
2. 删除所有 StockWhisperer 相关脚本
3. 重新创建脚本
4. **确保复制了完整的文件内容**：
   ```javascript
   // ==UserScript==
   // @name         ...
   // ...所有内容...
   // ==/UserScript==

   (function() {
       'use strict';
       // ...代码...
   })();
   ```
5. 检查最后是否有 `})();`

#### 问题 C: @match 规则问题

当前规则：
```javascript
// @match        https://quote.eastmoney.com/*
// @match        https://emweb.eastmoney.com/*
```

**测试**: 在控制台运行
```javascript
/https:\/\/quote\.eastmoney\.com\/.*/.test(window.location.href)
```

如果返回 `false`，说明 URL 不匹配。

---

## 🚀 最可能的解决方案

### 原因分析

从你的截图看，URL 是 `file://blob:http://tauri.localhost/...`，这说明：

1. **你使用的是 Tauri 应用程序**，不是普通浏览器
2. **Tampermonkey 可能无法在 Tauri 中正常工作**
3. **或者脚本被某种方式拦截了**

### 立即尝试

#### 步骤1: 使用普通浏览器（Chrome/Edge）

1. **关闭 Tauri 应用**
2. **打开普通 Chrome 浏览器**
3. **访问**: https://quote.eastmoney.com/SZ000001.html
4. **检查 Tampermonkey 图标**：
   - 图标上应该有数字 "1"
   - 图标应该是彩色的
5. **查看控制台是否有日志**

#### 步骤2: 如果普通浏览器也不行

**使用测试脚本**:

1. 只安装 `stockwhisperer-test.user.js`（测试版）
2. 访问股票页面
3. 应该会看到：
   - 红色横幅
   - Alert 弹窗
   - 控制台日志

#### 步骤3: 检查 Tampermonkey 权限

1. 点击 Tampermonkey 图标
2. 点击 "管理面板"
3. 点击每个脚本旁边的 "详细信息"
4. 检查权限设置，确保：
   - ✅ 脚本已启用
   - ✅ 有访问页面的权限

---

## 📋 请提供以下信息

为了更好地帮你解决问题，请告诉我：

1. **使用的浏览器**:
   - [ ] Chrome
   - [ ] Edge
   - [ ] Firefox
   - [ ] Tauri 应用
   - [ ] 其他：___

2. **测试脚本的显示**（如果安装了 test 版本）:
   - [ ] 看到红色横幅
   - [ ] 看到 Alert 弹窗
   - [ ] 控制台有日志
   - [ ] 以上都没有

3. **Tampermonkey 状态**:
   - [ ] 图标有数字
   - [ ] 脚本列表中显示 "东方财富AI预测助手"
   - [ ] 脚本开关是彩色的（开启状态）

4. **尝试普通浏览器了吗？**
   - [ ] 是的，普通浏览器也不行
   - [ ] 否，只用 Tauri

---

## 🔄 临时解决方案

如果油猴脚本确实无法在你的环境中运行，我们可以：

### 方案 A: 改为浏览器扩展

开发一个真正的 Chrome 扩展（不是油猴脚本），兼容性更好。

### 方案 B: 改为独立应用

开发一个独立的桌面应用程序。

### 方案 C: 使用在线版本

我可以在服务器上部署一个在线版本，你只需访问网页即可使用。

---

## ✅ 下一步行动

**请立即执行以下操作**:

1. **打开普通 Chrome 浏览器**（不是 Tauri）
2. **安装测试脚本**: `stockwhisperer-test.user.js`
3. **访问**: https://quote.eastmoney.com/SZ000001.html
4. **告诉我是否看到红色横幅或 Alert**

这样我们就能确定问题出在哪里了！

---

**补充说明**:

你的环境（Tauri）可能是一个打包的桌面应用。这种情况下：
- Tampermonkey 可能无法正常工作
- 需要使用普通浏览器测试
- 或者我们需要换一种技术方案

请先在**普通 Chrome/Edge 浏览器**中测试，然后告诉我结果！
