# StockWhisperer 系统架构设计

## 文档信息
- **版本**: v1.0
- **创建日期**: 2026-01-28
- **最后更新**: 2026-01-30
- **状态**: 初稿
- **架构模式**: 单体架构 + Go Workspace模块化

---

## 目录

- [一、功能模块设计](#一功能模块设计)
- [二、技术架构设计](#二技术架构设计)
- [三、数据架构设计](#三数据架构设计)
- [四、接口设计规范](#四接口设计规范)
- [五、安全架构设计](#五安全架构设计)
- [六、代码仓库架构](#六代码仓库架构)
- [七、部署架构设计](#七部署架构设计)
- [八、监控与运维](#八监控与运维)
- [九、扩展性设计](#九扩展性设计)
- [十、性能优化策略](#十性能优化策略)

---

## 一、功能模块设计

### 1.1 模块一:实时行情系统

#### 1.1.1 基础行情查询
- **功能描述**:查询A股实时价格、涨跌幅、成交量等基础数据
- **数据字段**:
  - 股票代码、名称
  - 最新价、涨跌额、涨跌幅
  - 今开、昨收、最高、最低
  - 成交量、成交额
  - 买一/卖一报价
  - 市盈率、市净率、总市值
- **技术实现**:
  - 使用 WebSocket (Gorilla WebSocket) 实时推送
  - RESTful API 按需查询
  - Go 协程池管理并发连接
  - Redis Pub/Sub 实现消息广播
  - 本地缓存机制 (go-cache)

#### 1.1.2 K线图表展示
- **功能描述**:展示日K、周K、月K、分钟K线
- **技术指标**:
  - MA均线(5/10/20/60日)
  - MACD、KDJ、RSI
  - BOLL布林带
  - 成交量柱状图
- **图表库**:ECharts / TradingView Lightweight Charts

#### 1.1.3 自选股管理
- **功能描述**:添加/删除自选股,分组管理
- **特性**:
  - 支持多个分组(重点关注、持仓、观察等)
  - 价格提醒功能
  - 自选股实时更新排序

#### 1.1.4 市场概览
- **功能描述**:展示大盘指数、板块涨跌、市场情绪
- **内容**:
  - 上证指数、深证成指、创业板指
  - 行业板块涨跌排行
  - 涨停板/跌停板统计
  - 北向资金流向

### 1.2 模块二:资讯与事件提醒系统

#### 1.2.1 财经新闻聚合
- **功能描述**:实时抓取并展示重要财经新闻
- **新闻分类**:
  - 市场快讯
  - 个股公告
  - 政策要闻
  - 国际财经
- **数据源**:
  - 东方财富、同花顺、新浪财经
  - 财联社、证券时报
  - 通过 gRPC 调用 NewsCrawler 独立服务获取
  - NewsCrawler 服务使用 Go 爬虫 (colly) 定时采集

#### 1.2.2 重要事件日历
- **功能描述**:展示即将发生的重大事件
- **事件类型**:
  - 财报发布时间
  - IPO日程
  - 重要会议(美联储、央行)
  - 经济数据发布(CPI、GDP等)
- **提醒方式**:
  - 提前N天提醒
  - 当日提醒
  - 推送通知

#### 1.2.3 个股公告监控
- **功能描述**:监控自选股的公告信息
- **公告类型**:
  - 年报/季报
  - 重大事项
  - 股东大会
  - 分红送转
- **智能摘要**:使用AI生成公告摘要

#### 1.2.4 舆情监控
- **功能描述**:监控股票相关的社交媒体讨论
- **监控平台**:
  - 微博、雪球
  - 股吧、东方财富论坛
- **技术实现**:
  - NewsCrawler 服务定时采集舆情数据
  - 主服务调用 AI API 进行情感分析
  - 异步任务队列处理
- **情感分析**:
  - 调用 AI API 获取正负面情绪打分
  - 热度趋势统计
  - 关键词提取(通过 AI API)

### 1.3 模块三:AI预测与分析系统

#### 1.3.1 短期走势预测(日内/1-3天)
- **输入数据**:
  - 历史价格序列(分钟级/日级)
  - 成交量、资金流向
  - 技术指标信号
  - 实时新闻情感
- **预测模型**:
  - LSTM时序预测
  - XGBoost分类模型(涨/跌/盘整)
  - 集成学习方法
- **输出结果**:
  - 预测走势图(概率分布)
  - 涨跌概率
  - 预测目标价位
  - 置信区间

#### 1.3.2 中长期走势预测(1周-3个月)
- **输入数据**:
  - 历史K线数据
  - 基本面数据(财报、估值)
  - 行业趋势
  - 宏观经济指标
- **预测模型**:
  - Transformer深度学习模型
  - 多因子模型
  - 行业轮动模型
- **输出结果**:
  - 趋势判断(上涨/下跌/震荡)
  - 目标价位区间
  - 时间周期预期
  - 风险评级

#### 1.3.3 智能投资建议
- **建议类型**:
  - 买入建议(强烈买入/买入/观望)
  - 卖出建议(卖出/强烈卖出/持有)
  - 仓位建议(百分比)
- **建议依据**:
  - 技术面分析
  - 基本面分析
  - 资金面分析
  - 情绪面分析
- **风险提示**:
  - 预测不确定性
  - 止损价位
  - 最大回撤预期

#### 1.3.4 预测可视化
- **图表类型**:
  - 预测K线图(未来走势)
  - 概率分布图
  - 走势对比图(实际vs预测)
  - 技术指标图
- **交互功能**:
  - 时间范围选择
  - 模型参数调整
  - 历史预测准确率查看

#### 1.3.5 模型评估与优化
- **评估指标**:
  - 预测准确率
  - 方向准确率
  - RMSE、MAPE
  - 夏普比率(策略回测)
- **模型管理**:
  - 多模型版本管理
  - A/B测试
  - 自动重训练机制
  - 模型性能监控

### 1.4 模块四:自动化交易系统

#### 1.4.1 策略引擎
- **策略类型**:
  - 趋势跟踪策略
  - 均值回归策略
  - 动量策略
  - AI预测策略
- **策略编辑器**:
  - 可视化策略构建
  - 代码编辑器(Python)
  - 策略模板库

#### 1.4.2 回测系统
- **功能描述**:基于历史数据验证策略有效性
- **回测指标**:
  - 总收益率
  - 年化收益率
  - 最大回撤
  - 夏普比率、索提诺比率
  - 胜率、盈亏比
- **回测报告**:
  - 收益曲线图
  - 持仓分析
  - 交易明细
  - 月度/年度收益统计

#### 1.4.3 模拟交易
- **功能描述**:虚拟资金进行实盘模拟
- **特性**:
  - 初始虚拟资金(如100万)
  - 实时行情模拟下单
  - 模拟成交撮合
  - 模拟滑点和手续费
- **记录功能**:
  - 交易日志
  - 持仓记录
  - 收益统计
  - 策略表现分析

#### 1.4.4 实盘交易(后期功能)
- **交易接口**:
  - 券商实盘接口(需授权)
  - 模拟盘接口
- **风控系统**:
  - 持仓限额
  - 单笔交易限额
  - 止损止盈自动执行
  - 异常交易熔断
- **交易监控**:
  - 实时持仓查看
  - 盈亏实时统计
  - 交易通知推送

#### 1.4.5 资金管理
- **功能描述**:自动化仓位管理
- **策略**:
  - 固定仓位
  - 凯利公式
  - 风险平价
  - 动态仓位调整
- **风控规则**:
  - 最大持仓比例
  - 单股最大仓位
  - 止损线设置
  - 分批建仓/平仓

---

## 二、技术架构设计

### 2.1 架构设计原则

**核心设计原则**:
1. **单体优先**:采用单体架构,避免微服务的管理复杂度和通信损耗
2. **模块化设计**:通过Go Workspace按业务领域拆分模块,便于管理和调用
3. **高可用性**:支持服务降级、熔断、限流
4. **可扩展性**:模块级扩展,支持垂直扩展和水平扩展
5. **数据一致性**:ACID事务保证强一致性
6. **安全性**:多层次安全防护
7. **可观测性**:完善的监控、日志、追踪

**技术选型原则**:
- **优先选择 Go 语言**:高性能、并发友好、部署简单
- **单体架构**:单进程部署,减少网络开销和运维复杂度
- **模块化**:Go Workspace管理多个Go模块,清晰的依赖关系
- **API 优先**:RESTful API 对外提供服务
- **内存优先**:充分利用Go的并发能力,减少外部依赖

### 2.2 系统分层架构

```
┌─────────────────────────────────────────────────────────────┐
│                     接入层 (Ingress)                         │
│              Nginx / Traefik (负载均衡、SSL终止)              │
└─────────────────────────────────────────────────────────────┘
                              ↕
┌─────────────────────────────────────────────────────────────┐
│                   前端展示层 (Web)                           │
│              StockWhisperer-Web (独立仓库)                  │
│          React 18+ / TypeScript / Vite / ECharts            │
└─────────────────────────────────────────────────────────────┘
              ↕ WebSocket/HTTP (JSON)
┌─────────────────────────────────────────────────────────────┐
│                 应用层 (单体应用)                            │
│              StockWhisperer (Go单体应用)                    │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              API层 (Gin框架)                       │   │
│  │        路由、中间件、JWT认证、限流                  │   │
│  └─────────────────────────────────────────────────────┘   │
│                           ↕                                 │
│  ┌─────────────────────────────────────────────────────┐   │
│  │            业务逻辑层 (Services)                    │   │
│  │  ┌────────┬────────┬────────┬────────┬────────┐    │   │
│  │  │行情服务│资讯服务│ AI服务│交易服务│用户服务│    │   │
│  │  └────────┴────────┴────────┴────────┴────────┘    │   │
│  │  (通过Go Workspace模块化组织,内部函数调用)          │   │
│  └─────────────────────────────────────────────────────┘   │
│                           ↕                                 │
│  ┌─────────────────────────────────────────────────────┐   │
│  │            数据访问层 (Repository)                  │   │
│  │      GORM/Redis Client/MongoDB Driver               │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
        ↕ HTTP            ↕            ↕            ↕
┌──────────────┐  ┌──────────┐  ┌──────────┐  ┌──────┐
│ NewsCrawler  │  │ AI APIs  │  │  存储     │  │缓存  │
│ (独立模块)   │  │          │  │          │  │      │
│ 新闻爬虫     │  │Deepseek/ │  │PostgreSQL│  │Redis │
│ HTTP调用     │  │通义千问  │  │TimescaleDB│  │      │
│             │  │ HTTP API │  │MongoDB   │  │      │
└──────────────┘  └──────────┘  └──────────┘  └──────┘
```

**架构说明**:
- **单体应用**:所有业务逻辑在一个Go应用进程中运行
- **模块化**:通过Go Workspace管理多个Go模块,清晰划分业务边界
- **内部调用**:模块间通过Go函数调用,无需网络通信
- **独立部署**:前端和NewsCrawler作为独立模块,通过HTTP API与主应用通信

### 2.3 后端技术栈

| 类别 | 技术选型 | 说明 |
|------|---------|------|
| **语言** | Go 1.21+ | 高性能、并发友好 |
| **Web框架** | Gin / Fiber / Echo | 轻量级、高性能 |
| **RPC框架** | gRPC + Protobuf | 服务间通信 |
| **数据库** | PostgreSQL 15+ | 主数据存储 |
| **时序数据库** | TimescaleDB | K线、tick数据 |
| **文档数据库** | MongoDB 6+ | 新闻、公告存储 |
| **缓存** | Redis 7+ | 分布式缓存 |
| **消息队列** | NATS / RabbitMQ | 异步消息 |
| **任务调度** | Asynq / go-cookier | 定时任务 |
| **ORM** | GORM / Ent | 对象关系映射 |
| **配置管理** | Viper | 配置文件解析 |
| **日志** | zap | 结构化日志 |
| **监控** | Prometheus + Grafana | 指标监控 |
| **追踪** | OpenTelemetry + Jaeger | 分布式追踪 |

### 2.4 前端技术栈

| 类别 | 技术选型 | 说明 |
|------|---------|------|
| **框架** | React 18+ | 组件化开发 |
| **语言** | TypeScript 5+ | 类型安全 |
| **构建工具** | Vite 5+ | 快速构建 |
| **状态管理** | Redux Toolkit / Zustand | 全局状态 |
| **路由** | React Router 6+ | 客户端路由 |
| **图表库** | ECharts 5+ / TradingView | K线图表 |
| **UI组件** | Ant Design / shadcn/ui | 组件库 |
| **HTTP客户端** | Axios / Fetch API | API调用 |
| **WebSocket** | Socket.io-client /原生WS | 实时通信 |
| **代码规范** | ESLint + Prettier | 代码质量 |
| **测试** | Vitest + Testing Library | 单元测试 |

### 2.5 AI技术栈

| 模型 | 角色 | SDK/API | 用途 |
|------|------|---------|------|
| **Deepseek** | 主要模型 | OpenAI兼容API | 情感分析、摘要、投资建议 |
| **通义千问** | 备用模型 | 阿里云SDK | 降级容灾、成本优化 |

**AI服务抽象层**:
```go
// 统一的AI服务接口
type AIService interface {
    AnalyzeSentiment(ctx context.Context, text string) (*SentimentResult, error)
    Summarize(ctx context.Context, content string) (string, error)
    GenerateAdvice(ctx context.Context, data *MarketData) (*InvestmentAdvice, error)
}

// 多模型实现
type DeepseekService struct{}
type QwenService struct{}

// 模型选择策略
type ModelSelector struct {
    primary  AIService
    fallback AIService
}
```

### 2.6 模块间通信机制

**模块间通信方式**:

1. **内部模块通信 (函数调用)**
   - 场景:应用内部服务间调用
   - 特点:零网络开销、类型安全、高性能
   - 示例:行情服务 → AI服务模块

2. **跨应用通信 (HTTP/REST)**
   - 场景:主应用与独立模块间调用
   - 特点:松耦合、语言无关、简单调试
   - 示例:主应用 → NewsCrawler模块

3. **实时通信 (WebSocket)**
   - 场景:实时行情、交易通知
   - 特点:双向通信、低延迟
   - 示例:前端 → 后端

4. **异步通信 (消息队列)**
   - 场景:事件驱动、解耦、削峰
   - 特点:最终一致性、高吞吐
   - 示例:行情数据推送、事件通知

**通信协议对比**:

| 协议 | 用途 | 优点 | 缺点 |
|------|------|------|------|
| 函数调用 | 应用内部模块 | 零开销、类型安全 | 仅限Go内部 |
| HTTP/REST | 跨应用调用 | 通用、简单、易调试 | 性能略低 |
| WebSocket | 实时推送 | 双向、低延迟 | 连接管理复杂 |
| Redis Pub/Sub | 进程内消息 | 高性能、实时 | 需要Redis |

### 2.7 数据流设计

**实时行情数据流**:
```
外部数据源 (东方财富等)
    ↓
Market数据采集服务
    ↓
Redis Pub/Sub (实时广播)
    ↓
    ├─→ WebSocket推送 → 前端展示
    ├─→ TimescaleDB (历史存储)
    └─→ AI服务 (情感分析)
```

**新闻资讯数据流**:
```
新闻源 (财经网站)
    ↓
NewsCrawler爬虫服务
    ↓
MongoDB (原始存储)
    ↓
gRPC调用 → 主服务
    ↓
    ├─→ Redis缓存 (热点数据)
    ├─→ AI API (摘要/情感)
    └─→ REST API → 前端
```

**AI预测数据流**:
```
历史数据 (TimescaleDB)
    ↓
特征工程
    ↓
预测模型 (LSTM/XGBoost)
    ↓
AI API增强 (Deepseek)
    ↓
预测结果
    ↓
PostgreSQL (结果存储)
    ↓
REST API → 前端可视化
```

---

## 三、数据架构设计

### 3.1 数据库选型

| 数据类型 | 存储方案 | 理由 |
|---------|---------|------|
| 用户数据、账户、交易记录 | PostgreSQL | ACID事务、关系型 |
| K线、tick数据 | TimescaleDB | 时序数据优化 |
| 新闻、公告、舆情 | MongoDB | 文档型、灵活schema |
| 实时行情、会话、缓存 | Redis | 高性能、过期策略 |

### 3.2 数据分层架构

```
┌─────────────────────────────────────────┐
│         应用层 (Application)             │
│    业务逻辑、数据转换、权限控制           │
└─────────────────────────────────────────┘
              ↕
┌─────────────────────────────────────────┐
│         数据访问层 (Repository)          │
│     ORM(GORM)、查询构建、缓存策略         │
└─────────────────────────────────────────┘
              ↕
┌─────────────────────────────────────────┐
│         缓存层 (Cache)                   │
│      Redis (本地缓存 + 分布式缓存)        │
└─────────────────────────────────────────┘
              ↕
┌─────────────────────────────────────────┐
│         存储层 (Storage)                 │
│  PostgreSQL + TimescaleDB + MongoDB     │
└─────────────────────────────────────────┘
```

### 3.3 数据一致性策略

**一致性级别**:
- **强一致性**:用户账户、交易记录 (使用数据库事务)
- **最终一致性**:新闻资讯、行情数据 (异步同步)
- **弱一致性**:统计数据、分析结果 (定期计算)

**分布式事务**:
- **Saga模式**:长事务拆分为多个本地事务
- **事件溯源**:记录事件日志,重放构建状态
- **补偿机制**:失败时执行补偿操作

### 3.4 缓存策略

**多级缓存架构**:
```
L1: 应用内存缓存 (sync.Map / go-cache)
    ↓ miss
L2: Redis 分布式缓存
    ↓ miss
L3: 数据库
```

**缓存模式**:
- **Cache-Aside**:应用管理缓存
- **Write-Through**:写时同步更新缓存
- **Write-Behind**:异步写回缓存

**缓存更新策略**:
- **过期策略**:TTL (Time To Live)
- **淘汰策略**:LRU / LFU
- **主动失效**:数据变更时主动清除

### 3.5 数据库设计概要

**PostgreSQL 核心表**:

```sql
-- 用户表
CREATE TABLE users (
    id BIGSERIAL PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- 股票基础信息表
CREATE TABLE stocks (
    id BIGSERIAL PRIMARY KEY,
    code VARCHAR(10) UNIQUE NOT NULL,
    name VARCHAR(50) NOT NULL,
    market VARCHAR(10) NOT NULL, -- SH/SZ
    industry VARCHAR(50),
    created_at TIMESTAMP DEFAULT NOW()
);

-- 自选股表
CREATE TABLE watchlist (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT REFERENCES users(id),
    stock_id BIGINT REFERENCES stocks(id),
    group_name VARCHAR(50),
    created_at TIMESTAMP DEFAULT NOW()
);

-- 交易记录表
CREATE TABLE transactions (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT REFERENCES users(id),
    stock_id BIGINT REFERENCES stocks(id),
    type VARCHAR(10) NOT NULL, -- BUY/SELL
    price DECIMAL(10,2) NOT NULL,
    quantity INTEGER NOT NULL,
    created_at TIMESTAMP DEFAULT NOW()
);
```

**TimescaleDB 时序表**:

```sql
-- 创建超表
CREATE TABLE stock_klines (
    time TIMESTAMP NOT NULL,
    stock_id BIGINT NOT NULL,
    open DECIMAL(10,2),
    high DECIMAL(10,2),
    low DECIMAL(10,2),
    close DECIMAL(10,2),
    volume BIGINT,
    amount DECIMAL(20,2)
);

-- 转换为 hypertable
SELECT create_hypertable('stock_klines', 'time');

-- 创建索引
CREATE INDEX idx_klines_stock_time ON stock_klines (stock_id, time DESC);
```

**MongoDB 文档结构**:

```javascript
// 新闻集合
db.news.insertOne({
  _id: ObjectId(),
  title: "财经新闻标题",
  content: "新闻内容",
  source: "东方财富",
  category: "市场快讯",
  related_stocks: ["000001", "000002"],
  published_at: ISODate("2026-01-30T10:00:00Z"),
  sentiment_score: 0.75,  // AI情感分析得分
  summary: "AI生成的摘要",
  created_at: ISODate("2026-01-30T10:00:05Z")
});
```

---

## 四、接口设计规范

### 4.1 RESTful API 设计

**URL设计规范**:
```
# 资源命名 (名词复数)
GET    /api/v1/stocks              # 获取股票列表
GET    /api/v1/stocks/:id          # 获取股票详情
POST   /api/v1/stocks              # 创建股票
PUT    /api/v1/stocks/:id          # 更新股票
DELETE /api/v1/stocks/:id          # 删除股票

# 嵌套资源
GET    /api/v1/stocks/:id/klines   # 获取K线数据
GET    /api/v1/users/:id/watchlist # 获取自选股

# 动作 (使用动词)
POST   /api/v1/stocks/:id/buy      # 买入
POST   /api/v1/stocks/:id/sell     # 卖出
```

**HTTP状态码**:
```
200 OK              - 成功
201 Created         - 创建成功
204 No Content      - 删除成功
400 Bad Request     - 请求参数错误
401 Unauthorized    - 未认证
403 Forbidden       - 无权限
404 Not Found       - 资源不存在
429 Too Many Requests - 限流
500 Internal Server Error - 服务器错误
503 Service Unavailable - 服务不可用
```

**响应格式**:
```json
{
  "code": 0,
  "message": "success",
  "data": {
    // 业务数据
  },
  "timestamp": 1706592000
}
```

**错误响应**:
```json
{
  "code": 1001,
  "message": "参数验证失败",
  "errors": [
    {
      "field": "stock_code",
      "message": "股票代码格式错误"
    }
  ],
  "timestamp": 1706592000
}
```

### 4.2 模块间HTTP接口设计

**跨模块接口**:
```
主应用 → NewsCrawler模块 (HTTP API)

# 获取最新新闻
GET http://newscrawler:8081/api/v1/news?limit=20

# 获取股票公告
GET http://newscrawler:8081/api/v1/announcements?stock=000001

# 获取舆情数据
GET http://newscrawler:8081/api/v1/sentiment?stock=000001
```

**接口规范**:
- 统一使用RESTful风格
- JSON格式数据交换
- JWT认证
- 限流保护

### 4.3 WebSocket 协议设计

**连接认证**:
```javascript
// 连接时携带token
const ws = new WebSocket(`wss://api.example.com/ws?token=${jwtToken}`);
```

**消息格式**:
```json
{
  "type": "quote_update",
  "data": {
    "code": "000001",
    "price": 10.50,
    "change": 0.05,
    "change_percent": 0.48
  },
  "timestamp": 1706592000
}
```

**心跳机制**:
```json
// 客户端每30秒发送ping
{"type": "ping", "timestamp": 1706592000}

// 服务端回复pong
{"type": "pong", "timestamp": 1706592000}
```

### 4.4 接口版本管理

**版本策略**:
- **URL版本**: `/api/v1/`, `/api/v2/`
- **Header版本**: `API-Version: v1`
- **向后兼容**:保持旧版本至少2个大版本

**版本废弃流程**:
1. 标记为废弃 (Warning Header)
2. 通知所有客户端 (至少3个月前)
3. 停止维护 (不再修复bug)
4. 关闭服务 (返回410 Gone)

---

## 五、安全架构设计

### 5.1 认证与授权

**认证方式**:
- **JWT Token**:无状态认证
- **OAuth 2.0**:第三方登录
- **API Key**:服务间调用

**JWT Token结构**:
```json
{
  "header": {
    "alg": "HS256",
    "typ": "JWT"
  },
  "payload": {
    "user_id": "123",
    "username": "alice",
    "roles": ["user"],
    "exp": 1706678400
  }
}
```

**授权模型 (RBAC)**:
```
角色 (Role):
  - admin:      管理员 (所有权限)
  - user:       普通用户 (基本功能)
  - vip:        VIP用户 (高级功能)

权限 (Permission):
  - market:read    查看行情
  - news:read      查看资讯
  - ai:use         使用AI功能
  - trading:execute 执行交易
```

### 5.2 数据加密

**传输加密**:
- HTTPS/TLS 1.3
- WebSocket Secure (WSS)
- gRPC over TLS

**存储加密**:
- 密码:bcrypt (cost=10)
- 敏感数据:AES-256-GCM
- API Key:Hash存储

**示例**:
```go
// 密码加密
hashedPassword, err := bcrypt.GenerateFromPassword(
    []byte(password),
    bcrypt.DefaultCost,
)

// AES加密
func EncryptData(plaintext []byte, key []byte) ([]byte, error) {
    block, err := aes.NewCipher(key)
    if err != nil {
        return nil, err
    }
    // GCM模式加密
    gcm, err := cipher.NewGCM(block)
    ciphertext := gcm.Seal(nonce, nonce, plaintext, nil)
    return ciphertext, nil
}
```

### 5.3 防护措施

**SQL注入防护**:
- 使用参数化查询
- ORM自动转义

**XSS防护**:
- 输入验证:白名单过滤
- 输出编码:HTML实体转义
- CSP:Content-Security-Policy

**CSRF防护**:
- CSRF Token
- SameSite Cookie
- Origin验证

**DDoS防护**:
- 限流:令牌桶算法
- 黑名单:IP封禁
- CDN:流量清洗

### 5.4 安全审计

**审计日志**:
```
用户登录/登出
敏感操作 (交易、修改密码)
API调用记录
异常访问检测
```

**日志格式**:
```json
{
  "event_type": "user_login",
  "user_id": "123",
  "ip": "192.168.1.1",
  "user_agent": "Mozilla/5.0...",
  "success": true,
  "timestamp": "2026-01-30T10:00:00Z"
}
```

---

## 六、代码仓库架构

### 6.1 Go Workspace 组织

**架构说明**:
- 采用**单体应用架构**,所有业务逻辑在一个Go应用中运行
- 通过**Go Workspace**管理多个Go模块,实现业务领域的清晰划分
- 模块间通过**Go函数调用**通信,零网络开销
- 前端和爬虫作为独立项目,通过HTTP API与主应用通信

**go.work 文件**:
```go
go 1.21

use (
    ./stock-whisperer      # 主应用(单体应用)
    ./newscrawler          # 新闻爬虫模块(独立Go模块)
)
```

**目录结构**:
```
stock-whisperer-project/
├── go.work                    # Go workspace配置
├── stock-whisperer/           # 主应用(单体应用)
│   ├── go.mod
│   ├── cmd/
│   │   └── api/              # 单一可执行程序
│   ├── internal/             # 私有代码
│   │   ├── service/         # 业务服务(模块化组织)
│   │   │   ├── market/      # 行情服务模块
│   │   │   ├── news/        # 资讯服务模块
│   │   │   ├── ai/          # AI服务模块
│   │   │   ├── trading/     # 交易服务模块
│   │   │   └── user/        # 用户服务模块
│   │   ├── repository/      # 数据访问层
│   │   ├── api/            # HTTP处理器
│   │   └── model/          # 数据模型
│   └── pkg/                 # 公共库
├── newscrawler/              # 新闻爬虫(独立Go模块)
│   ├── go.mod
│   ├── cmd/
│   └── internal/
└── stock-whisperer-web/       # 前端(独立项目)
    ├── package.json
    └── src/
```

**模块依赖关系**:
```
stock-whisperer (主应用)
    ├── internal/service/market   (行情模块)
    ├── internal/service/news     (资讯模块) --HTTP调用--> newscrawler
    ├── internal/service/ai       (AI模块) --HTTP调用--> Deepseek/通义千问
    ├── internal/service/trading  (交易模块)
    └── internal/service/user     (用户模块)
```

### 6.2 主应用:StockWhisperer (单体应用)

```
stock-whisperer/
├── cmd/                        # 可执行程序
│   └── api/                   # 单一API服务入口
│       └── main.go            # 应用启动入口
├── internal/                   # 私有代码(不可外部导入)
│   ├── api/                   # HTTP层
│   │   ├── middleware/        # 中间件(JWT、限流、日志)
│   │   ├── handler/           # 请求处理器
│   │   └── router/            # 路由配置
│   ├── service/               # 业务逻辑层(模块化)
│   │   ├── market/            # 行情服务模块
│   │   │   ├── service.go     # 服务接口
│   │   │   ├── realtime.go    # 实时行情
│   │   │   └── kline.go       # K线数据
│   │   ├── news/              # 资讯服务模块
│   │   │   ├── service.go
│   │   │   └── client.go      # HTTP客户端调用newscrawler
│   │   ├── ai/                # AI服务模块
│   │   │   ├── service.go
│   │   │   ├── deepseek.go    # Deepseek客户端
│   │   │   └── qwen.go        # 通义千问客户端
│   │   ├── trading/           # 交易服务模块
│   │   │   ├── service.go
│   │   │   └── strategy.go    # 策略引擎
│   │   └── user/              # 用户服务模块
│   │       └── service.go
│   ├── repository/            # 数据访问层
│   │   ├── postgres/          # PostgreSQL访问
│   │   ├── timescaledb/       # TimescaleDB访问
│   │   ├── mongodb/           # MongoDB访问
│   │   └── redis/             # Redis访问
│   ├── model/                 # 数据模型
│   │   ├── domain/            # 领域模型
│   │   └── dto/               # 数据传输对象
│   └── config/                # 配置管理
├── pkg/                        # 公共库(可外部导入)
│   ├── logger/                # 日志工具(zap封装)
│   ├── cache/                 # 缓存封装(本地+Redis)
│   ├── errors/                # 错误处理
│   ├── middleware/            # 公共中间件
│   └── utils/                 # 工具函数
├── scripts/                    # 脚本
│   ├── build.sh               # 构建脚本
│   └── deploy.sh              # 部署脚本
├── configs/                    # 配置文件
│   ├── config.yaml            # 开发配置
│   └── config.prod.yaml       # 生产配置
├── go.mod
├── go.sum
├── Dockerfile
└── README.md
```

**关键说明**:
- **单一可执行程序**:只有`cmd/api`一个入口
- **模块化服务**:业务逻辑按领域划分到不同的service包
- **内部调用**:service之间通过Go函数调用,无网络开销
- **清晰分层**:API层 → Service层 → Repository层

### 6.3 爬虫模块:NewsCrawler (独立Go模块)

```
newscrawler/
├── cmd/
│   ├── server/                # HTTP服务器
│   │   └── main.go
│   └── worker/                # 定时爬取任务
│       └── main.go
├── internal/
│   ├── api/                   # HTTP API
│   │   ├── handler/           # 处理器
│   │   └── router/            # 路由
│   ├── crawler/               # 爬虫引擎
│   │   ├── eastmoney/         # 东方财富爬虫
│   │   ├── sina/              # 新浪财经爬虫
│   │   └── collector/         # 数据收集器
│   ├── parser/                # 内容解析器
│   │   ├── news/              # 新闻解析
│   │   └── announcement/      # 公告解析
│   ├── repository/            # 数据存储
│   │   ├── mongodb/           # MongoDB访问
│   │   └── redis/             # Redis缓存
│   └── model/                 # 数据模型
├── go.mod
├── Dockerfile
└── README.md
```

**HTTP API示例**:
```
# 获取最新新闻
GET /api/v1/news?limit=20&category=market

Response:
{
  "code": 0,
  "data": {
    "news": [
      {
        "id": "123",
        "title": "新闻标题",
        "content": "新闻内容",
        "source": "东方财富",
        "published_at": "2026-01-30T10:00:00Z"
      }
    ]
  }
}

# 获取股票舆情
GET /api/v1/sentiment?stock=000001&days=7

Response:
{
  "code": 0,
  "data": {
    "stock_code": "000001",
    "sentiment_score": 0.75,
    "trend": "up",
    "keywords": ["上涨", "利好"]
  }
}
```

**与主应用集成**:
```go
// 主应用中调用NewsCrawler
type NewsService struct {
    crawlerClient *http.Client // HTTP客户端
    crawlerURL    string       // NewsCrawler服务地址
}

func (s *NewsService) GetLatestNews(limit int) ([]*News, error) {
    url := fmt.Sprintf("%s/api/v1/news?limit=%d", s.crawlerURL, limit)
    resp, err := s.crawlerClient.Get(url)
    // 处理响应...
}
```

### 6.4 前端:StockWhisperer-Web (独立项目)

```
stock-whisperer-web/
├── public/                     # 静态资源
│   ├── favicon.ico
│   └── index.html
├── src/                        # 源代码
│   ├── api/                    # API封装
│   │   ├── market.ts           # 行情API
│   │   ├── news.ts             # 资讯API
│   │   ├── ai.ts               # AI API
│   │   ├── trading.ts          # 交易API
│   │   └── config.ts           # API配置(基础URL)
│   ├── assets/                 # 资源文件
│   │   ├── images/
│   │   └── styles/
│   ├── components/             # 组件
│   │   ├── common/             # 通用组件
│   │   ├── market/             # 行情组件
│   │   ├── news/               # 资讯组件
│   │   ├── trading/            # 交易组件
│   │   └── charts/             # 图表组件
│   ├── pages/                  # 页面
│   │   ├── Dashboard/          # 仪表板
│   │   ├── Market/             # 行情页面
│   │   ├── News/               # 资讯页面
│   │   ├── Analysis/           # AI分析页面
│   │   ├── Trading/            # 交易页面
│   │   └── Settings/           # 设置页面
│   ├── hooks/                  # 自定义Hooks
│   │   ├── useWebSocket.ts     # WebSocket钩子
│   │   ├── useMarketData.ts    # 行情数据钩子
│   │   └── useAuth.ts          # 认证钩子
│   ├── store/                  # 状态管理
│   │   ├── market/             # 行情状态
│   │   ├── user/               # 用户状态
│   │   └── trading/            # 交易状态
│   ├── types/                  # TypeScript类型
│   ├── utils/                  # 工具函数
│   ├── constants.ts            # 常量
│   ├── App.tsx                 # 根组件
│   └── main.tsx                # 入口
├── tests/                      # 测试
├── .eslintrc.cjs               # ESLint配置
├── .prettierrc                 # Prettier配置
├── tsconfig.json               # TypeScript配置
├── vite.config.ts              # Vite配置
├── package.json
├── Dockerfile
└── README.md
```

**API配置**:
```typescript
// src/api/config.ts
export const API_CONFIG = {
  BASE_URL: import.meta.env.VITE_API_URL || 'http://localhost:8080',
  WS_URL: import.meta.env.VITE_WS_URL || 'ws://localhost:8080/ws',
  TIMEOUT: 10000,
};

// src/api/market.ts
import axios from 'axios';
import { API_CONFIG } from './config';

export const marketAPI = {
  // 获取实时行情
  getRealtimeQuote: (code: string) =>
    axios.get(`${API_CONFIG.BASE_URL}/api/v1/market/quote/${code}`),

  // 获取K线数据
  getKlines: (code: string, period: string) =>
    axios.get(`${API_CONFIG.BASE_URL}/api/v1/market/klines`, {
      params: { code, period }
    }),
};
```

---

## 七、部署架构设计

### 7.1 容器化部署

**部署架构说明**:
- **单体应用部署**:主应用作为单个Docker容器部署
- **水平扩展**:通过增加应用实例实现扩展
- **独立模块**:NewsCrawler作为独立容器部署
- **前端**:独立容器部署,使用Nginx托管静态资源

**Docker Compose (开发环境)**:
```yaml
version: '3.8'

services:
  # 主应用(单体应用)
  api:
    build:
      context: ./stock-whisperer
      dockerfile: Dockerfile
    ports:
      - "8080:8080"
    environment:
      - DATABASE_URL=postgres://admin:password@postgres:5432/stockwhisperer
      - REDIS_URL=redis://redis:6379
      - NEWSCRAWLER_URL=http://newscrawler:8081
      - DEEPSEEK_API_KEY=${DEEPSEEK_API_KEY}
      - QWEN_API_KEY=${QWEN_API_KEY}
    depends_on:
      - postgres
      - timescaledb
      - mongodb
      - redis
      - newscrawler
    restart: unless-stopped

  # NewsCrawler爬虫模块(独立容器)
  newscrawler:
    build:
      context: ./newscrawler
      dockerfile: Dockerfile
    ports:
      - "8081:8081"
    environment:
      - MONGODB_URL=mongodb://mongodb:27017
      - REDIS_URL=redis://redis:6379
    depends_on:
      - mongodb
      - redis
    restart: unless-stopped

  # 前端
  web:
    build:
      context: ./stock-whisperer-web
      dockerfile: Dockerfile
    ports:
      - "80:80"
    depends_on:
      - api
    restart: unless-stopped

  # PostgreSQL
  postgres:
    image: postgres:15
    environment:
      POSTGRES_DB: timeseries
      POSTGRES_USER: admin
      POSTGRES_PASSWORD: password
    volumes:
      - timescaledb_data:/home/postgres/pgdata/data

  # MongoDB
  mongodb:
    image: mongo:6
    volumes:
      - mongodb_data:/data/db

  # Redis
  redis:
    image: redis:7-alpine
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data

  # NATS
  nats:
    image: nats:latest
    command: "-js"

  # 主服务
  api:
    build:
      context: ./stock-whisperer
      dockerfile: Dockerfile
    environment:
      - DATABASE_URL=postgres://...
      - REDIS_URL=redis://redis:6379
    depends_on:
      - postgres
      - redis
    ports:
      - "8080:8080"

  # 爬虫服务
  crawler:
    build:
      context: ./news-crawler
      dockerfile: Dockerfile
    depends_on:
      - mongodb
      - nats

volumes:
  postgres_data:
  timescaledb_data:
  mongodb_data:
  redis_data:
```

### 7.2 Kubernetes (生产环境)

**部署架构说明**:
- **水平扩展**:通过Deployment副本数实现
- **负载均衡**:Service + Ingress实现流量分发
- **自动扩缩容**:HPA根据CPU/内存使用率调整副本数
- **独立部署**:主应用和NewsCrawler分别部署

**命名空间划分**:
```
namespaces:
  - stockwhisperer-prod    # 生产环境
  - stockwhisperer-staging # 预发布环境
  - stockwhisperer-dev     # 开发环境
  - monitoring             # 监控组件
```

**主应用部署清单**:
```yaml
# api-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: stockwhisperer-api
  namespace: stockwhisperer-prod
spec:
  replicas: 3  # 单体应用多副本部署
  selector:
    matchLabels:
      app: api
  template:
    metadata:
      labels:
        app: api
    spec:
      containers:
      - name: api
        image: registry.example.com/stockwhisperer/api:v1.0.0
        ports:
        - containerPort: 8080
        env:
        - name: DATABASE_URL
          valueFrom:
            secretKeyRef:
              name: db-secret
              key: url
        - name: NEWSCRAWLER_URL
          value: "http://newscrawler-service:8081"
        - name: DEEPSEEK_API_KEY
          valueFrom:
            secretKeyRef:
              name: ai-secret
              key: deepseek
        resources:
          requests:
            memory: "512Mi"
            cpu: "500m"
          limits:
            memory: "1Gi"
            cpu: "1000m"
        livenessProbe:
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /ready
            port: 8080
          initialDelaySeconds: 5
          periodSeconds: 5

---
apiVersion: v1
kind: Service
metadata:
  name: api-service
  namespace: stockwhisperer-prod
spec:
  selector:
    app: api
  ports:
  - protocol: TCP
    port: 80
    targetPort: 8080
  type: ClusterIP

---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: api-hpa
  namespace: stockwhisperer-prod
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: stockwhisperer-api
  minReplicas: 3
  maxReplicas: 10
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80
```
  - stockwhisperer-staging # 预发布环境
  - stockwhisperer-dev     # 开发环境
  - monitoring             # 监控组件
```

**部署清单示例**:
```yaml
# api-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: stockwhisperer-api
  namespace: stockwhisperer-prod
spec:
  replicas: 3
  selector:
    matchLabels:
      app: api
  template:
    metadata:
      labels:
        app: api
    spec:
      containers:
      - name: api
        image: registry.example.com/stockwhisperer/api:v1.0.0
        ports:
        - containerPort: 8080
        env:
        - name: DATABASE_URL
          valueFrom:
            secretKeyRef:
              name: db-secret
              key: url
        resources:
          requests:
            memory: "256Mi"
            cpu: "250m"
          limits:
            memory: "512Mi"
            cpu: "500m"
        livenessProbe:
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /ready
            port: 8080
          initialDelaySeconds: 5
          periodSeconds: 5

---
apiVersion: v1
kind: Service
metadata:
  name: api-service
  namespace: stockwhisperer-prod
spec:
  selector:
    app: api
  ports:
  - protocol: TCP
    port: 80
    targetPort: 8080
  type: ClusterIP

---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: api-ingress
  namespace: stockwhisperer-prod
  annotations:
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
    nginx.ingress.kubernetes.io/rate-limit: "100"
spec:
  tls:
  - hosts:
    - api.example.com
    secretName: api-tls
  rules:
  - host: api.example.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: api-service
            port:
              number: 80
```

### 7.3 CI/CD流程

**GitHub Actions示例**:
```yaml
name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'

    - name: Run tests
      run: |
        go test -v -race -coverprofile=coverage.out ./...
        go tool cover -html=coverage.out -o coverage.html

    - name: Upload coverage
      uses: codecov/codecov-action@v3

  build:
    needs: test
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Login to Registry
      uses: docker/login-action@v2
      with:
        registry: registry.example.com
        username: ${{ secrets.REGISTRY_USER }}
        password: ${{ secrets.REGISTRY_PASS }}

    - name: Build and push
      uses: docker/build-push-action@v4
      with:
        context: .
        push: true
        tags: |
          registry.example.com/stockwhisperer/api:${{ github.sha }}
          registry.example.com/stockwhisperer/api:latest
        cache-from: type=gha
        cache-to: type=gha,mode=max

  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
    - name: Deploy to Kubernetes
      uses: azure/k8s-deploy@v4
      with:
        manifests: |
          k8s/api-deployment.yaml
          k8s/api-service.yaml
          k8s/api-ingress.yaml
        images: |
          registry.example.com/stockwhisperer/api:${{ github.sha }}
```

---

## 八、监控与运维

### 8.1 监控体系

**监控层次**:
```
基础设施监控
  ├── CPU、内存、磁盘、网络
  ├── 容器状态
  └── 节点健康

应用监控
  ├── QPS、延迟、错误率
  ├── 慢查询、慢接口
  └── 业务指标 (用户数、交易量)

日志监控
  ├── 错误日志聚合
  ├── 访问日志分析
  └── 异常检测

链路追踪
  ├── 请求链路可视化
  ├── 性能瓶颈定位
  └── 依赖关系分析
```

### 8.2 Prometheus监控指标

**关键指标**:
```go
// HTTP请求指标
var (
    httpRequestsTotal = prometheus.NewCounterVec(
        prometheus.CounterOpts{
            Name: "http_requests_total",
            Help: "Total number of HTTP requests",
        },
        []string{"method", "endpoint", "status"},
    )

    httpRequestDuration = prometheus.NewHistogramVec(
        prometheus.HistogramOpts{
            Name:    "http_request_duration_seconds",
            Help:    "HTTP request duration in seconds",
            Buckets: prometheus.DefBuckets,
        },
        []string{"method", "endpoint"},
    )
)

// 业务指标
var (
    activeUsers = prometheus.NewGauge(
        prometheus.GaugeOpts{
            Name: "active_users_total",
            Help: "Number of active users",
        },
    )

    aiRequestsTotal = prometheus.NewCounterVec(
        prometheus.CounterOpts{
            Name: "ai_requests_total",
            Help: "Total number of AI API requests",
        },
        []string{"model", "type"},
    )
)
```

**Grafana Dashboard**:
```
- 服务概览
  - QPS、延迟、错误率
  - CPU、内存、网络
  - Goroutines、GC

- 数据库监控
  - 连接数、慢查询
  - 缓存命中率
  - 存储空间

- 业务监控
  - 活跃用户数
  - AI调用次数
  - 交易量统计
```

### 8.3 日志管理

**日志级别**:
```
DEBUG   - 开发调试信息
INFO    - 关键业务流程
WARN    - 警告信息
ERROR   - 错误信息
FATAL   - 致命错误
```

**结构化日志**:
```go
import "go.uber.org/zap"

logger, _ := zap.NewProduction()
defer logger.Sync()

logger.Info("用户登录",
    zap.String("user_id", "123"),
    zap.String("ip", "192.168.1.1"),
    zap.Duration("latency", 100*time.Millisecond),
)
```

**ELK Stack**:
```
日志流:
应用 → Filebeat → Elasticsearch → Kibana
```

### 8.4 告警策略

**告警级别**:
```
P0 - 严重 (立即处理)
  - 服务不可用
  - 数据丢失
  - 安全漏洞

P1 - 高 (1小时内)
  - 性能严重下降
  - 错误率飙升
  - 资源耗尽

P2 - 中 (24小时内)
  - 性能轻微下降
  - 偶发错误
  - 磁盘空间不足

P3 - 低 (定期处理)
  - 潜在问题
  - 优化建议
```

**Prometheus告警规则**:
```yaml
groups:
- name: api_alerts
  rules:
  - alert: HighErrorRate
    expr: rate(http_requests_total{status=~"5.."}[5m]) > 0.05
    for: 5m
    labels:
      severity: P1
    annotations:
      summary: "API错误率过高"
      description: "错误率: {{ $value }}"

  - alert: HighLatency
    expr: histogram_quantile(0.95, http_request_duration_seconds) > 1
    for: 10m
    labels:
      severity: P2
    annotations:
      summary: "API延迟过高"
```

---

## 九、扩展性设计

### 9.1 水平扩展

**无状态设计**:
- API服务无状态,支持水平扩展
- Session存储在Redis中
- 使用负载均衡分发请求

**扩展策略**:
```
自动扩缩容 (HPA):
  - CPU使用率 > 70% → 扩容
  - CPU使用率 < 30% → 缩容
  - 最小副本数: 2
  - 最大副本数: 10
```

### 9.2 数据库扩展

**读写分离**:
```
主库:处理写操作
  ↓
从库:处理读操作 (多个)
  ↓
中间件:ProxySQL / MaxScale
```

**分库分表**:
```
按用户ID分片:
  user_0, user_1, ..., user_9

按时间分片:
  trade_2026_01, trade_2026_02, ...
```

### 9.3 缓存扩展

**Redis集群**:
```
Redis Cluster (自动分片):
  - 16384个哈希槽
  - 3主3从
  - 自动故障转移
```

**CDN加速**:
```
静态资源:
  HTML/CSS/JS → CDN
  图片/视频 → CDN

API响应:
  公开数据 → CDN边缘缓存
```

### 9.4 服务扩展

**微服务拆分**:
```
初期:单体应用
  ↓
中期:核心服务拆分
  - 行情服务
  - 资讯服务
  - 交易服务
  ↓
后期:细粒度服务
  - 每个功能独立服务
```

---

## 十、性能优化策略

### 10.1 后端优化

**并发优化**:
```go
// 协程池
pool := tunny.NewFunc(10, func(payload interface{}) interface{} {
    // 处理任务
    return result
})

// 批量处理
for _, item := range items {
    go pool.Process(item)
}
```

**数据库优化**:
```sql
-- 索引优化
CREATE INDEX idx_stock_time ON stock_klines (stock_id, time DESC);

-- 查询优化
EXPLAIN ANALYZE SELECT * FROM stock_klines WHERE stock_id = 1;

-- 批量插入
INSERT INTO stock_klines VALUES
  (..., ...),
  (..., ...),
  (..., ...);
```

**缓存优化**:
```go
// 多级缓存
func GetStock(code string) (*Stock, error) {
    // L1: 本地缓存
    if stock := localCache.Get(code); stock != nil {
        return stock, nil
    }

    // L2: Redis缓存
    stock, err := redis.Get(code)
    if err == nil {
        localCache.Set(code, stock, 5*time.Minute)
        return stock, nil
    }

    // L3: 数据库
    stock, err = db.GetStock(code)
    if err != nil {
        return nil, err
    }

    // 回写缓存
    redis.Set(code, stock, 10*time.Minute)
    localCache.Set(code, stock, 5*time.Minute)

    return stock, nil
}
```

### 10.2 前端优化

**代码分割**:
```typescript
// 路由懒加载
const Dashboard = lazy(() => import('./pages/Dashboard'));
const Market = lazy(() => import('./pages/Market'));

// 组件懒加载
const HeavyComponent = lazy(() => import('./components/HeavyComponent'));
```

**虚拟滚动**:
```typescript
import { FixedSizeList } from 'react-window';

<FixedSizeList
  height={600}
  itemCount={10000}
  itemSize={50}
  width="100%"
>
  {({ index, style }) => (
    <div style={style}>Row {index}</div>
  )}
</FixedSizeList>
```

**图片优化**:
```typescript
// 懒加载
<img loading="lazy" src="image.jpg" alt="..." />

// 响应式图片
<img
  srcSet="image-320w.jpg 320w,
          image-640w.jpg 640w,
          image-1280w.jpg 1280w"
  sizes="(max-width: 320px) 280px,
         (max-width: 640px) 600px,
         1280px"
  src="image-1280w.jpg"
/>
```

### 10.3 网络优化

**HTTP/2**:
```
优势:
  - 多路复用
  - 头部压缩
  - 服务器推送
```

**gRPC优化**:
```protobuf
// 使用流式传输
rpc SubscribeQuotes(stream SubscribeRequest)
    returns (stream QuoteSnapshot);

// 消息压缩
option gzip_compression = true;
```

**WebSocket优化**:
```javascript
// 消息压缩
const msg = JSON.stringify(data);
const compressed = pako.deflate(msg);
ws.send(compressed);

// 批量发送
const batch = [];
setInterval(() => {
    if (batch.length > 0) {
        ws.send(JSON.stringify(batch));
        batch.length = 0;
    }
}, 100);
```

---

## 版本历史

| 版本 | 日期 | 变更内容 | 作者 |
|------|------|----------|------|
| v1.0 | 2026-01-28 | 初始版本,基于功能点文档创建 | - |
| v1.0 | 2026-01-30 | 补充完善架构设计,更名为架构设计文档 | - |

## 相关文档
- [需求分析 v1.0](需求分析_v1.0.md) - 项目需求分析
- [初始需求](初始需求.md) - 项目初始需求文档
- [API设计规范](API设计规范.md) - 接口设计详细说明 (待创建)
- [数据库设计](数据库设计.md) - 数据库设计详细说明 (待创建)

---

**文档维护**:本文档随项目演进持续更新,如有变更请及时更新版本号和变更记录。